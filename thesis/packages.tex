%=============================  Font selection  ==============================
\usepackage[T1]{fontenc}
    % Defines the encoding of the characters output by LaTeX.  With T1,
    % characters are encoded with 8 bits, allowing many accented European
    % characters to be encoded with a single glyph.  This makes hyphenation
    % of words containing these characters possible.  Otherwise, by default,
    % TeX uses 7 bits per character and cannot hyphenate accented words.
    % T1 is also called "Cork Encoding":
    %    https://en.wikipedia.org/wiki/Cork_encoding
    % It's kind of old though: it's LaTeX that's lagging behind.
    % XeTeX and LuaTex are UTF-8 all the way.
    
%=======================  UTF-8 support in the source  =======================
\usepackage[utf8]{inputenc}
    % Allows me to input accented characters directly from my keyboard instead
    % of having to type G\"odel.
    % Note that bibtex does not support that, so in my .bib files I must still
    % enter the annoying characters.

\usepackage{lmodern}

%===============================  DEPENDENCIES  ==============================
\RequirePackage{snapshot}
    % Generates a .dep files that contains all the files (pictures and stuff)
    % on which a document depends.

%==================================  FLOATS  =================================

% According to
% http://tex.stackexchange.com/questions/96350/problem-with-algorithmic-and-hyperref
% if I want to have hyperref working with algorithm, I must
% first load float, then hyperref, then algorithm.
% Putting float here solves the TOC links to the algorithms, otherwise they'd
% all point to page 1.
% Also, putting float-algo-hyper creates a massive amount of warnings for pretty much
% every algo command like \State.
\usepackage{float}

\usepackage{placeins}
    % Brings \FloatBarrier command. It forces Tex to typeset all remaining floats
    % at that point and doesn't include a \clearpage afterwards.
    % Nice to flush all the floats before beginning a new section.

\usepackage[font=footnotesize,labelfont=bf,margin=1cm]{caption}
    % So that I can add long captions under figures.
    
    % It provides me with \caption* that does not appear in the list of
    % figures but formats the text like \caption does.  It also lets me
    % use line breaks in the caption, and even bullet/enumerated lists.
    
    % The margin of 1 cm makes it easier to see what's caption and what's
    % main-body text when there's a float on top of a page.

\usepackage{subcaption}
    % Lets me have labels such as a) b) c) inside a figure environment.
    % Unfortunately something is broken, I cannot give labels to these
    % subcaptions when hyperef is active, the pdf compiler hangs forever.
    % Seems to be a common problem.

\usepackage{rotating}
    % Used to display long tables in landscape mode.

%http://tex.stackexchange.com/questions/38972/how-to-forbid-latex-to-put-text-between-figures
\renewcommand\topfraction{0.70}
\renewcommand\bottomfraction{0.70}
\renewcommand\textfraction{0.20}
%http://www-rohan.sdsu.edu/~aty/bibliog/latex/floats.html
% Alter some LaTeX defaults for better treatment of figures:
    % See p.105 of "TeX Unbound" for suggested values.
    % See pp. 199-200 of Lamport's "LaTeX" book for details.
    %   General parameters, for ALL pages:
%    \renewcommand{\topfraction}{0.9}	% max fraction of floats at top
%    \renewcommand{\bottomfraction}{0.8}	% max fraction of floats at bottom
    %   Parameters for TEXT pages (not float pages):
\setcounter{totalnumber}{4} % default 3    % 2 may work better
\setcounter{topnumber}{4} % default 2
\setcounter{bottomnumber}{4} % default 1
%    \setcounter{dbltopnumber}{2}    % for 2-column pages
%    \renewcommand{\dbltopfraction}{0.9}	% fit big float above 2-col. text
%    \renewcommand{\textfraction}{0.07}	% allow minimal text w. figs
    %   Parameters for FLOAT pages (not text pages):
%    \renewcommand{\floatpagefraction}{0.7}	% require fuller float pages
	% N.B.: floatpagefraction MUST be less than topfraction !!
%    \renewcommand{\dblfloatpagefraction}{0.7}	% require fuller float pages

	% remember to use [htp] or [htpb] for placement

%===============================  BACKMATTER  ================================

\usepackage{makeidx}
    % Needed to build the index.

\usepackage[toc,page]{appendix}
    % Brings \begin{appendices}.
    % toc option creates an "appendices" entry in the table of content.
    % page option creates a page before the first appendix chapter.

%\usepackage[sorting=nyt,citestyle=authoryear,backref=false,]{biblatex}
\usepackage[backend=bibtex,style=authoryear,sorting=nyt]{biblatex}
    % Fantastic bibliography manager that I'll use just for its
    % \citetitle command.
    % For sorting orders, see
    % https://www.sharelatex.com/blog/2013/07/31/getting-started-with-biblatex.html
    % backref does not work with hyperref.
\DefineBibliographyStrings{english}{%
    backrefpage  = {see p.}, % for single page number
    backrefpages = {see pp.} % for multiple page numbers
}
\newcommand{\citeformula}[1]{\text{\citetitle{#1}}}

%===========================  HEADERS AND FOOTERS  ===========================
\usepackage{fancyhdr}
\pagestyle{fancy}
\let\originalchaptermark\chaptermark

\makeatletter
    \renewcommand{\chaptermark}[1]{%
        \if@mainmatter
            \originalchaptermark{#1}%
        \else
            \markboth{#1}{}%
        \fi
    }
\makeatother

% Note: Even pages (E) are on the left, odd (O) pages on the right.
\addtolength{\headheight}{\baselineskip}
\fancyhf{}  % First, start with a clean slate.
\fancyhead[LE,RO]{\thepage}
\fancyhead[RE]{\slshape\nouppercase\leftmark}
\fancyhead[LO]{\slshape\nouppercase\rightmark}
%\renewcommand{\headrulewidth}{\iffloatpage{0pt}{0.4pt}}


\fancypagestyle{plain}{%
    \fancyhf{}
    \fancyfoot[LE,RO]{\thepage}
    \renewcommand{\headrulewidth}{0pt}
    \renewcommand{\footrulewidth}{0pt}
}

\makeatletter
    \def\cleardoublepage{
        \clearpage\if@twoside \ifodd\c@page\else
        \hbox{}
        \vspace*{\fill}
        %\begin{center}
        %This page intentionally contains only this sentence.
        %\end{center}
        \vspace{\fill}
        \thispagestyle{empty}
        \newpage
        \if@twocolumn\hbox{}\newpage\fi\fi\fi
    }
\makeatother


%=================================  TESTING  =================================
\usepackage{lipsum}


%==============================  SUBDIRECTORIES  =============================

\usepackage{import}
    % Facilitates the organization of the book.  I can place each chapter in its own
    % directory, along with its images.
    % Brings /subimport{directory}{tex_file_name_without_extension}.

%===================================  COLOR  =================================

\usepackage[table]{xcolor}
    % The 'table' parameter loads another package that lets me set
    % alternating colors for the rows of a table.
    % xcolor also imports color, which is useful for importing figures saved as
    % PDF+TEX files generated by inkscape.
    
    % Must be loaded before todonotes: todonotes loads color without the [table]
    % option.

%=================================  DRAFTING  ================================

\ifDraft
    \usepackage{todonotes}
        % Big post-its, handy while writing.
\else
    \usepackage[disable]{todonotes}
\fi

%===============================  MATHEMATICS  ===============================

%---------------------------------  FORMULAS  --------------------------------
\usepackage{amsmath}
    % Brings the align environment for lining up equations on the =.

\usepackage{nicefrac}

\usepackage{bm}
    % For bold mathematics.
    % An advantage of using \bm over \mathbf is that \bm keeps the
    % letters slanted in maths.  I use bold letters for vectors,
    % I see no reason to have them typeset upright.
    % Another advantage is that it works on greek letters too.

\usepackage{amssymb}
    % For the Real/Complex/etc. number set symbols via \mathbb.

\usepackage[makeroom]{cancel}
    % For striking out bits of equations that simplify.

\usepackage{stmaryrd}
    % For the llbracket and rrbracket to denote integer intervals.

% Fix the spacing introduced by \left and \right in formulas.
\let\originalleft\left
\let\originalright\right
\renewcommand{\left}{\mathopen{}\mathclose\bgroup\originalleft}
\renewcommand{\right}{\aftergroup\egroup\originalright}

% Macro to wrap something between top corners, useful for GÃ¶del number
% or litteral predicates.
\newbox\gnBoxA
\newdimen\gnCornerHgt
\setbox\gnBoxA=\hbox{$\ulcorner$}
\global\gnCornerHgt=\ht\gnBoxA
\newdimen\gnArgHgt
\def\cornered #1{%
\setbox\gnBoxA=\hbox{$#1$}%
\gnArgHgt=\ht\gnBoxA%
\ifnum     \gnArgHgt<\gnCornerHgt \gnArgHgt=0pt%
\else \advance \gnArgHgt by -\gnCornerHgt%
\fi \raise\gnArgHgt\hbox{$\ulcorner$} \box\gnBoxA %
\raise\gnArgHgt\hbox{$\urcorner$}}
% Use \cornered{blah}.

% Class theory.
\newcommand{\classname}[1]{\mathcal{#1}}
\newcommand{\tuple}[1]{\begin{bmatrix}#1\end{bmatrix}}
\newcommand{\smalltuple}[1]{\big[ \begin{smallmatrix}#1\end{smallmatrix} \big]}

% Category theory.
\newcommand{\catname}[1]{\mathbf{#1}}            % Category name.
\newcommand{\morph}[3]{#1 : #2 \to #3}           % Morphism.
\DeclareMathOperator{\classHom}{hom}             % Class of morphisms.
\DeclareMathOperator{\classOb}{ob}               % Class of objects.
\DeclareMathOperator{\id}{id}                    % Identity morphism.
\DeclareMathOperator{\dom}{dom}                  % Domain.
\DeclareMathOperator{\cod}{cod}                  % Codomain.
\DeclareMathOperator{\apply}{\$}                 % Arrow application. 


% Set theory.
\newcommand{\innerprod}[2]{\langle #1, #2 \rangle}
\newcommand{\innerprodd}[1]{\innerprod{#1}{#1}}
\newcommand{\Innerprod}[2]{\left\langle #1, #2 \right\rangle}
\newcommand{\Innerprodd}[1]{\Innerprod{#1}{#1}}
%\newcommand{\inprod}[2]{\langle #1, #2 \rangle}  % Inner product of two vectors.
%\newcommand{\vangle}[2]{\left(#1, #2\right)}     % Angle between vectors.
\DeclareMathOperator{\spanset}{Sp}               % Span, in the linear algebra sense.
\DeclareMathOperator{\Over}{over}                % (V, *) over F is a vector field.
\DeclareMathOperator{\End}{End}                  % End(X) = set of endomorphisms of X.
\DeclareMathOperator{\Aut}{Aut}                  % Aut(X) = set of automorphisms of X.
\newcommand{\card}[1]{\left\lvert #1 \right\rvert}         % Cardinal of a set.
%
% This command writes a function in the form
%
%    f : A --> B
%        a |-> b
%
% The parameters are f, A, B, a and b in that order:
% f is the function name, A the domain, B the codomain, a an element of A and b an
% element of B.
\newcommand{\func}[5]{
    \begin{array}{rccc}
        #1: & #2 & \to     & #3\\
            & #4 & \mapsto & #5
    \end{array}
}
% For set or list comprehension.
% example: $\{ \comp{(x,y)}{x^2+y^2=1} \}$ renders as {(x,y) | x^2+y^2=1}.
\newcommand{\comp}[2]{#1 \mid #2}


% Scalars.
\newcommand{\abs}[1]{\left\lvert #1 \right\rvert}          % Absolute value of a scalar.
\newcommand{\cp}[1]{\hat{#1}}                    % Complex object.
    % Used as indices:
\newcommand{\re}{r} % Real part.
\newcommand{\im}{i} % Imaginary part.

% Vectors.
\newcommand{\norm}[1]{\left\| #1 \right\|}       % Norm of a vector.
\newcommand{\vect}[1]{\bm{#1}}                   % Real vector.
\newcommand{\vectcp}[1]{\cp{\vect{#1}}}          % Complex vector.
\newcommand{\vectu}[1]{\dot{\vect{#1}}}          % Unit (real) vectors.

% Matrices.
\newcommand{\matr}[1]{\mathrm{#1}}               % Real matrix.
\newcommand{\matrcp}[1]{\cp{\matr{#1}}}          % Complex matrix.
\newcommand{\transp}{^\top}                      % Tranposed of a matrix.

% Trigonometry.
\DeclareMathOperator{\atantwo}{arctan2}            % Arctan(y, x).

% Calculus.
\newcommand{\dif}{\operatorname{d}}              % For integrals: dx dy dz.
\newcommand{\timeavg}[1]{\langle #1 \rangle}
\newcommand{\Timeavg}[1]{\left\langle #1 \right\rangle}

% Bullshit.
\newcommand{\equaldef}{\stackrel{\text{\tiny def}}{=}}

% Probabilities.
\DeclareMathOperator{\prob}{P}

%----------------------------------  LOGIC  ----------------------------------
\usepackage{bussproofs}
\renewcommand{\iff}{\mathbin{\longleftrightarrow}} % More correct than \iff and \implies for
\renewcommand{\implies}{\mathbin{\longrightarrow}} % first-order logic.
\newcommand{\lxor}{\oplus}                         % Logical exclusive or.
\newcommand{\dn}{\mathord{\downarrow}}
\newcommand{\up}{\mathord{\uparrow}}
\newcommand{\entails}{{\enspace}\mathbin{\vdash}{\enspace}}

% Predicates.
\newcommand{\litpred}[1]{\cornered{#1}}
\DeclareMathOperator{\Category}{Category}
\DeclareMathOperator{\Class}{Class}
\DeclareMathOperator{\Monoid}{Monoid}
\DeclareMathOperator{\Evt}{Evt}
\DeclareMathOperator{\Indep}{Indep}
\DeclareMathOperator{\Excl}{Excl}

%---------------------------------  THEOREMS  --------------------------------
\usepackage{amsthm}
\newtheorem{axiom}{Axiom}
\newtheorem{theorem}{Theorem}

%================================  QUANTITIES  ===============================

\usepackage{siunitx}
    % Otherwise I can't write the mu symbol for micrometers.
    % It also brings me the \degree symbol, woo!
    % No decibel though, I need to make this one myself.
    
    % My version of siunitx is too old so I cannot use \DeclareSIUnit to create
    % new units.
\newcommand{\decibel}{dB}  % \DeclareSIunit doesn't work with my version.
\newcommand{\parsec}{pc}
\newcommand{\astronomicalunit}{au}  % Was ua until 2014.
\newcommand{\mass}{M}
\newcommand{\charge}{Q}
\newcommand{\distance}{L}
\newcommand{\duration}{T}
\newcommand{\bit}{bit}

%=================================  PHYSICS  =================================

% Used as indices:
\newcommand{\I}{I} % Incident.
\newcommand{\R}{R} % Reflected.
\newcommand{\T}{T} % Transmitted/refracted.
\newcommand{\power}[1]{\mathcal{#1}}

%================================  CHEMISTRY  ================================

\usepackage[version=3]{mhchem}
    % For chemical formulas.
    % Brings \ce.

\newcommand{\Jlevel}[2]{$J=#1\!\rightarrow\!#2$}
\newcommand{\transition}[3]{\ce{#1}~\Jlevel{#2}{#3}}

%================================  DIAGRAMS  =================================

\usepackage[all]{xy}
\usepackage{tikz}
\usepackage{pgfkeys}

%==================================  LISTS  ==================================

\usepackage{enumitem}
    % Allows customization of bullet-lists and numbered-lists.
    % In particular, allows removing the insane amount of vertical space that latex
    % injects in these lists by default.
    % Usage: \begin{itemize}[noitemsep,nolistsep]
    % noitemsep removes the spacing between the items.
    % nolistsep removes the spacing between the paragraph and the list.
    % Global usage: \setlist[itemize]{noitemsep}
    % Except that this global usage doesn't work on my old installation.


%=================================  PICTURES  ================================

\usepackage{graphicx}
    % Can't have pictures/photos/figures from files without that.
    % Note that vanilla latex will only accept eps while tex2pdf accepts
    % anything except eps.  Go figure...



%=================================  TABLES  ==================================

\usepackage{booktabs}
    % For professional-looking tables.
    % Brings the \toprule, \midrule and \bottomrule.
    % Remember not to use vertical rules in tables: they look cheap.

\usepackage{multirow}
    % How isn't that even standard?

\usepackage{tabularx}
    % Brings the X column type, auto expand to fill the page.

\usepackage{array}
    % Brings >{} and <{} column modifiers to wrap the content into stuff.

% And this is convenient too because it allows me to set the width of a column,
% like p does, but with left/right/center justification.
\newcolumntype{L}[1]{>{\raggedright\arraybackslash}p{#1}}
\newcolumntype{C}[1]{>{\centering\arraybackslash}p{#1}}
\newcolumntype{R}[1]{>{\raggedleft\arraybackslash}p{#1}}

%=============================  CROSS REFERENCES  ============================

% As a rule of thumb, hyperref goes last.  Only a few packages go after.
% cleveref is a well known one.  bookmark is another one.

% According to
% http://tex.stackexchange.com/questions/53191/impact-of-hyperref-when-varioref-and-cleveref-are-used/53193#53193
% one must first load varioref, then hyperref, then cleveref.
% Failure to do so results in lots of hyperrefs warnings and links that do not point to the right place.
\usepackage{varioref}
    % For fancier references that also tell the page number.

\ifPrint
    \usepackage[draft]{hyperref}
\else
    \usepackage[plainpages=false, hypertexnames=false]{hyperref}
    % Requires direct pdf output, therefore all figures should be pdf too.
    % This creates hyperlinks all over the place to jump to figures, references,
    % chapters and all.
    % hypertexnames=false makes the package dumber, allowing it to work even if
    % there are several chapter 1 in the document.
    \hypersetup{
        colorlinks,
        linkcolor={red!50!black},
        citecolor={green!40!black},
        urlcolor={blue!80!black}
    }
\fi
    
%\usepackage[capitalize,noabbrev]{cleveref}
\usepackage[capitalize]{cleveref}
    % Should make the typesetting of cross references more consistent.
    % Note that I needed to install a recent version of this package, the one I had
    % was too old to handle algorithms properly.
    % NOTE that cleveref is confused by the subcaption package.  Whenever you place
    % a label in a subfigure, cleveref hangs forever.  The label at the figure level
    % works fine though.  So, no labeling of subfigures :(.
    %
    % Interesting options:
    %    noabbrev
    %    capitalize
\crefname{appsec}{appendix}{appendices}
\Crefname{appsec}{Appendix}{Appendices}
\crefname{axithm}{axiom}{axioms}
\Crefname{axithm}{Axiom}{Axioms}
\crefname{thmthm}{theorem}{theorems}
\Crefname{thmthm}{Theorem}{Theorems}

%=============================  ALGOS AND CODE  ==============================

% According to
% http://tex.stackexchange.com/questions/113719/cleveref-fails-to-reference-algorithms
% Algorithm must be loaded before hyperref.  Well, it is not true.
\usepackage[chapter]{algorithm}
    % To float algorithms.
\usepackage{algpseudocode}
    % For pseudocode.
\usepackage{listings}
    % For real code.

%===============================  SPECIAL TEXT  ==============================

\hyphenation{aniso-tro-pic iso-tro-pic impe-dance va-cuum algo-rithm algo-rithms col-linear pe-rio-dic tera-hertz}
\newcommand{\radex}{\textsc{radex}}
\newcommand{\Radex}{\textsc{Radex}}

%===========================  WIDOWS AND ORPHANS  ============================

% I hate having a paragraph that has only one line on a page.
% It's made even worse when there's a float cutting the paragraph in two.
% Here, I am telling LaTeX that windows and orphans are infinitely bad.
% http://tex.stackexchange.com/questions/4152/how-do-i-prevent-widow-orphan-lines
\widowpenalty10000
\clubpenalty10000

%===============================  WEIRD THINGS  ==============================

% This thing helps filtering some warnings during debugging.  There often are
% warnings caused by very small overfull hboxes and they `pollute' the log,
% drowning the more critical warnings.  Although I believe that a document
% should compile with zero warning, it also makes sense to solve the big
% problems first.  The following command is supposed to make LaTeX stop
% complaining when the boxes are only slightly overfull.
% Ref: http://tex.stackexchange.com/questions/183972/package-biblatex-warning-data-encoding-is-utf8-use-backend-biber
%\hfuzz = 30pt
